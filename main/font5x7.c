#include "font5x7.h"

#include <stdbool.h>

// 5x7 font for a small subset of ASCII needed for Wi-Fi status UI.
// Each row uses 5 LSB bits (bit 4 = leftmost pixel).
typedef struct {
    char c;
    uint8_t rows[7];
} glyph5x7_t;

// Includes: space, punctuation, digits, and letters used in:
// "WiFi: connecting", "WiFi: connected", "WiFi: failed", "IP: x.x.x.x"
static const glyph5x7_t GLYPHS_5X7[] = {
    { ' ', { 0x00,0x00,0x00,0x00,0x00,0x00,0x00 } },
    { '.', { 0x00,0x00,0x00,0x00,0x00,0x18,0x18 } },
    { ':', { 0x00,0x18,0x18,0x00,0x18,0x18,0x00 } },
    { '-', { 0x00,0x00,0x00,0x1F,0x00,0x00,0x00 } },
    { '=', { 0x00,0x00,0x1F,0x00,0x1F,0x00,0x00 } },

    { '0', { 0x0E,0x11,0x13,0x15,0x19,0x11,0x0E } },
    { '1', { 0x04,0x0C,0x04,0x04,0x04,0x04,0x0E } },
    { '2', { 0x0E,0x11,0x01,0x02,0x04,0x08,0x1F } },
    { '3', { 0x1F,0x02,0x04,0x02,0x01,0x11,0x0E } },
    { '4', { 0x02,0x06,0x0A,0x12,0x1F,0x02,0x02 } },
    { '5', { 0x1F,0x10,0x1E,0x01,0x01,0x11,0x0E } },
    { '6', { 0x06,0x08,0x10,0x1E,0x11,0x11,0x0E } },
    { '7', { 0x1F,0x01,0x02,0x04,0x08,0x08,0x08 } },
    { '8', { 0x0E,0x11,0x11,0x0E,0x11,0x11,0x0E } },
    { '9', { 0x0E,0x11,0x11,0x0F,0x01,0x02,0x0C } },

    { 'I', { 0x1F,0x04,0x04,0x04,0x04,0x04,0x1F } },
    { 'P', { 0x1E,0x11,0x11,0x1E,0x10,0x10,0x10 } },
    { 'C', { 0x0E,0x11,0x10,0x10,0x10,0x11,0x0E } },
    { 'T', { 0x1F,0x04,0x04,0x04,0x04,0x04,0x04 } },
    { 'W', { 0x11,0x11,0x11,0x15,0x15,0x15,0x0A } },
    { 'F', { 0x1F,0x10,0x10,0x1E,0x10,0x10,0x10 } },
    { 'O', { 0x0E,0x11,0x11,0x11,0x11,0x11,0x0E } },
    { 'A', { 0x0E,0x11,0x11,0x1F,0x11,0x11,0x11 } },
    { 'B', { 0x1E,0x11,0x11,0x1E,0x11,0x11,0x1E } },
    { 'D', { 0x1E,0x11,0x11,0x11,0x11,0x11,0x1E } },
    { 'E', { 0x1F,0x10,0x10,0x1E,0x10,0x10,0x1F } },
    { 'N', { 0x11,0x19,0x15,0x13,0x11,0x11,0x11 } },
    { 'R', { 0x1E,0x11,0x11,0x1E,0x14,0x12,0x11 } },
    { 'S', { 0x0F,0x10,0x10,0x0E,0x01,0x01,0x1E } },
    { 'U', { 0x11,0x11,0x11,0x11,0x11,0x11,0x0E } },
    { 'X', { 0x11,0x0A,0x04,0x04,0x0A,0x11,0x00 } },

    { 'a', { 0x00,0x00,0x0E,0x01,0x0F,0x11,0x0F } },
    { 'c', { 0x00,0x00,0x0E,0x10,0x10,0x10,0x0E } },
    { 'd', { 0x01,0x01,0x0D,0x13,0x11,0x13,0x0D } },
    { 'e', { 0x00,0x00,0x0E,0x11,0x1F,0x10,0x0F } },
    { 'f', { 0x06,0x08,0x08,0x1E,0x08,0x08,0x08 } },
    { 'g', { 0x00,0x00,0x0F,0x11,0x0F,0x01,0x0E } },
    { 'i', { 0x04,0x00,0x0C,0x04,0x04,0x04,0x0E } },
    { 'j', { 0x02,0x00,0x06,0x02,0x02,0x12,0x0C } },
    { 'l', { 0x10,0x10,0x10,0x10,0x10,0x10,0x0E } },
    { 'n', { 0x00,0x00,0x16,0x19,0x11,0x11,0x11 } },
    { 'o', { 0x00,0x00,0x0E,0x11,0x11,0x11,0x0E } },
    { 't', { 0x08,0x08,0x1E,0x08,0x08,0x08,0x06 } },
    { 'p', { 0x00,0x00,0x1E,0x11,0x1E,0x10,0x10 } },
    { 'r', { 0x00,0x00,0x16,0x19,0x10,0x10,0x10 } },
    { 's', { 0x00,0x00,0x0F,0x10,0x0E,0x01,0x1E } },
    { 'u', { 0x00,0x00,0x11,0x11,0x11,0x13,0x0D } },
    { 'x', { 0x00,0x00,0x11,0x0A,0x04,0x0A,0x11 } },
    { 'b', { 0x10,0x10,0x16,0x19,0x11,0x19,0x16 } },
    { 'h', { 0x10,0x10,0x16,0x19,0x11,0x11,0x11 } },
    { 'm', { 0x00,0x00,0x1A,0x15,0x15,0x15,0x15 } },
    { 'v', { 0x00,0x00,0x11,0x11,0x11,0x0A,0x04 } },
    { 'w', { 0x00,0x00,0x11,0x11,0x15,0x15,0x0A } },
    { 'k', { 0x10,0x10,0x12,0x14,0x18,0x14,0x12 } },
    { 'y', { 0x00,0x00,0x11,0x11,0x0F,0x01,0x0E } },
    { '_', { 0x00,0x00,0x00,0x00,0x00,0x00,0x1F } },
    { '?', { 0x0E,0x11,0x01,0x02,0x04,0x00,0x04 } },
};

static const glyph5x7_t *glyph_find(char c)
{
    for (size_t i = 0; i < (sizeof(GLYPHS_5X7) / sizeof(GLYPHS_5X7[0])); i++) {
        if (GLYPHS_5X7[i].c == c) {
            return &GLYPHS_5X7[i];
        }
    }
    return NULL;
}

static void draw_char_5x7(uint16_t *fb, int fb_w, int fb_h, int x, int y, char c, uint16_t fg, uint16_t bg, int scale)
{
    const glyph5x7_t *g = glyph_find(c);
    if (!g) {
        g = glyph_find(' ');
    }

    for (int row = 0; row < 7; row++) {
        uint8_t bits = g->rows[row] & 0x1F;
        for (int col = 0; col < 5; col++) {
            const bool on = (bits & (1 << (4 - col))) != 0;
            const uint16_t color = on ? fg : bg;
            const int px0 = x + col * scale;
            const int py0 = y + row * scale;
            for (int dy = 0; dy < scale; dy++) {
                const int py = py0 + dy;
                if (py < 0 || py >= fb_h) continue;
                for (int dx = 0; dx < scale; dx++) {
                    const int px = px0 + dx;
                    if (px < 0 || px >= fb_w) continue;
                    fb[py * fb_w + px] = color;
                }
            }
        }
    }
}

void rs3_draw_text_5x7(uint16_t *fb, int fb_w, int fb_h, int x, int y, const char *s, uint16_t fg, uint16_t bg, int scale)
{
    const int adv = (5 + 1) * scale; // 1px spacing
    for (const char *p = s; *p; p++) {
        draw_char_5x7(fb, fb_w, fb_h, x, y, *p, fg, bg, scale);
        x += adv;
    }
}


